"use strict";var e=function(e){return"string"==typeof e},t=function(e){return"number"==typeof e},i=function(e){return"function"==typeof e};function r(e,i,r,n){this.name=e,this.namespace=i,this.func=r,this.priority=t(n)?n:1}var n=function(){function n(n){var s=this;this._emitter_events=[],this._emitter_oneTime=[],this.reachedMaxListeners=function(e){return s._emitter_events.filter((function(t){return t.name===e})).length>=s._emitter_config.maxListeners},this.reachedMaxOnceListeners=function(e){return s._emitter_oneTime.filter((function(t){return t.name===e})).length>=s._emitter_config.maxListeners},this.getEventIndex=function(e,t){for(var i=s._emitter_events.length;i;)if(i-=1,s._emitter_events[i].name===e&&s._emitter_events[i].namespace===t)return i;return-1},this.getEvents=function(e){for(var t=[],i=0,r=s._emitter_events.length;i<r;i+=1)((s._emitter_events[i].name.indexOf("*")>-1||s._emitter_events[i].name.indexOf("?")>-1)&&new RegExp(s._emitter_events[i].name.replace(/\*/g,".*")).test(e)||s._emitter_events[i].name===e)&&t.push(s._emitter_events[i]);return t},this.register=function(n,m,o,u){if(n){var h,a="all",l=1;void 0!==u&&t(u)&&(l=u),i(m)?e(o)?(h=m,a=o):(t(o)&&(l=o),h=m,a="all"):(a=m,h=o);var c=s.getEventIndex(n,a),d=new r(n,a,h,l);-1===c?s.reachedMaxListeners(n)?console.warn("Max listeners reached for event ".concat(n)):s._emitter_events.push(d):s._emitter_events[c]=d,s._emitter_events.sort((function(e,t){return e.priority===t.priority?0:e.priority<t.priority?1:-1}))}},this.on=this.register,this.subscribe=this.register,this.once=function(e,t){if(e){var i=new r(e,"",t,1);s.reachedMaxOnceListeners(e)?console.warn("Max once listeners reached for event ".concat(e)):s._emitter_oneTime.push(i)}},this.onMany=function(e,t){t&&Object.keys(t).forEach((function(i){s.on(i,e,t[i])}))},this.unregister=function(e,t){if(void 0===t&&(t="all"),e){var i=0;if("all"!==(t=t||"all"))-1!==(i=s.getEventIndex(e,t))&&s._emitter_events.splice(i,1);else{for(i=s._emitter_events.length;i;)i-=1,s._emitter_events[i].name===e&&"all"===s._emitter_events[i].namespace&&s._emitter_events.splice(i,1);for(i=s._emitter_oneTime.length;i;)i-=1,s._emitter_oneTime[i].name===e&&s._emitter_oneTime.splice(i,1)}}},this.off=this.unregister,this.unsubscribe=this.unregister,this.offAll=function(e){for(var t=s._emitter_events.length;t;)t-=1,s._emitter_events[t].namespace===e&&s._emitter_events.splice(t,1)},this.triggerOneTime=function(e,t){for(var i=s._emitter_oneTime.length;i;)i-=1,((s._emitter_oneTime[i].name.indexOf("*")>-1||s._emitter_oneTime[i].name.indexOf("?")>-1)&&new RegExp(s._emitter_oneTime[i].name.replace(/\*/g,".*").replace(/\?/g,".")).test(e)||s._emitter_oneTime[i].name===e)&&(s._emitter_oneTime[i].func(t,e),s._emitter_oneTime.splice(i,1))},this.trigger=function(e,t){for(var i=s.getEvents(e),r=0,n=i.length;r<n;r+=1)i[r].func(t,e);s.triggerOneTime(e,t)},this.emit=this.trigger,this.publish=this.trigger,this.propagate=function(e,t){s.trigger(t,e)},this.isRegistered=function(e,t){t=t||"all";for(var i=s._emitter_events.length;i;)if(i-=1,s._emitter_events[i].namespace===t&&s._emitter_events[i].name===e)return!0;for(i=s._emitter_oneTime.length;i;)if(i-=1,s._emitter_oneTime[i].name===e)return!0;return!1},this._emitter_config=n||{maxListeners:50,maxOnceListeners:50}}return Object.defineProperty(n.prototype,"config",{get:function(){return this._emitter_config},enumerable:!1,configurable:!0}),n.HIGH_PRIORITY=2,n.NORMAL_PRIORITY=1,n.LOW_PRIORITY=0,n}();const s={object:e=>"object"==typeof e&&null!==e,number:e=>"number"==typeof e,string:e=>"string"==typeof e,array:e=>Array.isArray(e),undef:e=>void 0===e,validID:e=>s.number(e)||s.string(e)},m=(e,t)=>{let i=!1;return!(!s.object(e)||!s.object(t))&&(Object.keys(t).forEach((r=>{if(s.object(e[r]))i=m(e[r],t[r])||i;else if(s.array(e[r])&&s.array(t[r]))for(let n=0,o=t[r].length;n<o;n++)s.object(e[r][n])?i=m(e[r][n],t[r][n])||i:e[r][n]!==t[r][n]&&(e[r][n]=t[r][n],i=!0);else e[r]!==t[r]&&(e[r]=t[r],i=!0)})),i)};module.exports=class extends n{constructor(e){super(),this.copy="undefined"!=typeof window&&window.structuredClone?structuredClone:e=>Object.assign({},e),this.getFirstByAttribute=this.getByAttribute,this.upsert=this.insert,this.ItemConstructor=e.itemConstructor,this.needsId=!1,s.validID(this.ItemConstructor.prototype.id)||(this.ItemConstructor.prototype.id=-1,this.needsId=!0),this.itemName=e.itemName,this.items=new Map,this.indexes=new Map}genId(){if(!this.needsId)return-1;let e=this.items.size;return this.getAllIds().reduce(((e,t)=>"string"==typeof t?e:Math.max(e,t)),e)+1}getName(){return this.itemName}clear(){this.items.clear(),this.indexes.clear()}indexItem(e,t){const i=void 0!==t?t:this.items.size-1;this.indexes.set(e,i),this.emit(`indexed-${this.itemName}`,`id: ${e}, index: ${i}`)}add(e){return!!s.object(e)&&(e=new this.ItemConstructor(e),this.needsId&&-1===e.id&&(e.id=this.genId()),this.items.set(e.id,e),this.emit(`added-${this.itemName}`,e),this.indexItem(e.id),!0)}addAll(e){return!!s.array(e)&&(e.forEach((e=>{this.add(e)})),!0)}getAll(){return Array.from(this.items.values())}getAllIds(){return Array.from(this.items.keys()).filter((e=>s.string(e)||s.number(e)))}getCopies(){return this.getAll().map((e=>this.copy(e)))}getCopy(e){let t=this.items.get(e);return t?this.copy(t):t}getById(e){return this.items.get(e)||null}getIndex(e){if(!s.validID(e))return-1;let t=this.indexes.get(e);return void 0===t?-1:t}getAttributeValue(e,t){if(t.includes(".")){let i=t.split(".").filter((e=>!!e.trim())),r=Object.assign({},e);for(let e=0,t=i.length;e<t;e++)r=r[i[e]];return r}return e[t]}getByAttribute(e,t){if(!s.string(e)||s.undef(t))return null;for(let i of this.items.values()){if(this.getAttributeValue(i,e)===t)return i}return null}getAllByAttribute(e,t){let i=[];if(!s.string(e)||s.undef(t))return i;for(let r of this.items.values()){t===this.getAttributeValue(r,e)&&i.push(r)}return i}setAttributes(e,t){if(!s.validID(e)||!s.object(t))return!1;if("string"==typeof e&&!e.trim())return!1;let i=this.getById(e);return null!==i&&(!!m(i,t)&&(this.items.set(i.id,i),this.emit(`set-${this.itemName}`,i),!0))}setAttributesByAttribute(e,t,i){if(!s.string(e)||!s.object(i))return[];if(i.id&&delete i.id,Object.keys(i).length<1)return[];return this.getAllByAttribute(e,t).map((e=>m(e,i)?(this.items.set(e.id,e),this.emit(`set-${this.itemName}`,e),{[e.id]:!0}):{[e.id]:!1}))}insert(e,t){if(!s.validID(e)||!s.array(t))return!1;let i=this.getIndex(e);if(-1===i)return!1;let r=[];for(let e=0,i=t.length;e<i;e++)this.update(t[e])||r.push(t[e]);const n=Array.from(this.items.values());return r.forEach(((e,t)=>{e=new this.ItemConstructor(e),this.needsId&&-1===e.id&&(e.id=this.genId());const r=i+1+t;n.splice(r,0,e),this.emit(`inserted-${this.itemName}`,e)})),this.clear(),n.forEach(((e,t)=>{this.items.set(e.id,e),this.indexes.set(e.id,t)})),!0}update(e){if(!s.object(e)||!s.validID(e.id))return!1;if(-1===this.getIndex(e.id))return!1;let t=this.getById(e.id);return!(!t||!m(t,e))&&(this.items.set(e.id,t),this.emit(`updated-${this.itemName}`,t),!0)}remove(e){if(!s.validID(e))return!1;if(this.items.delete(e)){this.emit(`removed-${this.itemName}`,e);const t=this.indexes.get(e);return this.indexes.delete(e),this.indexes.forEach(((e,i)=>{e>=t&&this.indexes.set(i,e-1)})),!0}return!1}};
