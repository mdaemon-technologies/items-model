"use strict";var e=function(e){return"string"==typeof e},t=function(e){return"number"==typeof e},n=function(e){return"function"==typeof e};function i(e,n,i,r){this.name=e,this.namespace=n,this.func=i,this.priority=t(r)?r:1}var r=function(){function r(r){var s=this;this._emitter_events=[],this._emitter_oneTime=[],this.reachedMaxListeners=function(e){return s._emitter_events.filter((function(t){return t.name===e})).length>=s._emitter_config.maxListeners},this.reachedMaxOnceListeners=function(e){return s._emitter_oneTime.filter((function(t){return t.name===e})).length>=s._emitter_config.maxListeners},this.getEventIndex=function(e,t){for(var n=s._emitter_events.length;n;)if(n-=1,s._emitter_events[n].name===e&&s._emitter_events[n].namespace===t)return n;return-1},this.getEvents=function(e){for(var t=[],n=0,i=s._emitter_events.length;n<i;n+=1)((s._emitter_events[n].name.indexOf("*")>-1||s._emitter_events[n].name.indexOf("?")>-1)&&new RegExp(s._emitter_events[n].name.replace(/\*/g,".*")).test(e)||s._emitter_events[n].name===e)&&t.push(s._emitter_events[n]);return t},this.register=function(r,o,u,a){if(r){var c,f="all",l=1;void 0!==a&&t(a)&&(l=a),n(o)?e(u)?(c=o,f=u):(t(u)&&(l=u),c=o,f="all"):(f=o,c=u);var m=s.getEventIndex(r,f),h=new i(r,f,c,l);-1===m?s.reachedMaxListeners(r)?console.warn("Max listeners reached for event ".concat(r)):s._emitter_events.push(h):s._emitter_events[m]=h,s._emitter_events.sort((function(e,t){return e.priority===t.priority?0:e.priority<t.priority?1:-1}))}},this.on=this.register,this.subscribe=this.register,this.once=function(e,t){if(e){var n=new i(e,"",t,1);s.reachedMaxOnceListeners(e)?console.warn("Max once listeners reached for event ".concat(e)):s._emitter_oneTime.push(n)}},this.onMany=function(e,t){t&&Object.keys(t).forEach((function(n){s.on(n,e,t[n])}))},this.unregister=function(e,t){if(void 0===t&&(t="all"),e){var n=0;if("all"!==(t=t||"all"))-1!==(n=s.getEventIndex(e,t))&&s._emitter_events.splice(n,1);else{for(n=s._emitter_events.length;n;)n-=1,s._emitter_events[n].name===e&&"all"===s._emitter_events[n].namespace&&s._emitter_events.splice(n,1);for(n=s._emitter_oneTime.length;n;)n-=1,s._emitter_oneTime[n].name===e&&s._emitter_oneTime.splice(n,1)}}},this.off=this.unregister,this.unsubscribe=this.unregister,this.offAll=function(e){for(var t=s._emitter_events.length;t;)t-=1,s._emitter_events[t].namespace===e&&s._emitter_events.splice(t,1)},this.triggerOneTime=function(e,t){for(var n=s._emitter_oneTime.length;n;)n-=1,((s._emitter_oneTime[n].name.indexOf("*")>-1||s._emitter_oneTime[n].name.indexOf("?")>-1)&&new RegExp(s._emitter_oneTime[n].name.replace(/\*/g,".*").replace(/\?/g,".")).test(e)||s._emitter_oneTime[n].name===e)&&(s._emitter_oneTime[n].func(t,e),s._emitter_oneTime.splice(n,1))},this.trigger=function(e,t){for(var n=s.getEvents(e),i=0,r=n.length;i<r;i+=1)n[i].func(t,e);s.triggerOneTime(e,t)},this.emit=this.trigger,this.publish=this.trigger,this.propagate=function(e,t){s.trigger(t,e)},this.isRegistered=function(e,t){t=t||"all";for(var n=s._emitter_events.length;n;)if(n-=1,s._emitter_events[n].namespace===t&&s._emitter_events[n].name===e)return!0;for(n=s._emitter_oneTime.length;n;)if(n-=1,s._emitter_oneTime[n].name===e)return!0;return!1},this._emitter_config=r||{maxListeners:50,maxOnceListeners:50}}return Object.defineProperty(r.prototype,"config",{get:function(){return this._emitter_config},enumerable:!1,configurable:!0}),r.HIGH_PRIORITY=2,r.NORMAL_PRIORITY=1,r.LOW_PRIORITY=0,r}();const s={object:e=>"object"==typeof e&&null!==e,number:e=>"number"==typeof e,string:e=>"string"==typeof e,array:e=>Array.isArray(e),undef:e=>void 0===e,validID:e=>s.number(e)||s.string(e)},o=(e,t)=>{let n=!1;return!(!s.object(e)||!s.object(t))&&(Object.keys(t).forEach((i=>{if(s.object(e[i]))n=o(e[i],t[i]);else if(s.array(e[i])&&s.array(t[i]))for(var r=0,u=t[i].length;r<u;r++)s.object(e[i][r])?n=o(e[i][r],t[i][r]):e[i][r]!==t[i][r]&&(e[i][r]=t[i][r],n=!0);else e[i]!==t[i]&&(e[i]=t[i],n=!0)})),n)};module.exports=function(e){const t=this;Object.assign(this,new r);const n=e.itemConstructor;let i=!1;s.validID(n.prototype.id)||(n.prototype.id=-1,i=!0);const u=()=>{let e=c.length;return t.getAllIds().reduce(((e,t)=>Math.max(e,t)),e)},a=e.itemName;this.getName=function(){return a};const c=new Map,f=new Map;this.clear=function(){c.clear(),f.clear()},this.add=function(e){return!!s.object(e)&&(e=new n(e),i&&-1===e.id&&(e.id=u()),c.set(e.id,e),t.emit(`added-${a}`,e),((e,n)=>{const i=c.size-1;f.set(e,i),t.emit(`indexed-${a}`,`id: ${e}, index: ${i}`)})(e.id),!0)},this.addAll=function(e){return!!s.array(e)&&(e.forEach((e=>{t.add(e)})),!0)},this.getAll=function(){return Array.from(c.values())},this.getAllIds=function(){return Array.from(c.keys()).filter((e=>s.string(e)||s.number(e)))};const l=window&&window.structuredClone?structuredClone:e=>Object.assign({},e);this.getCopies=function(){return t.getAll().map((e=>l(e)))},this.getCopy=function(e){let t=c.get(e);return t?l(t):t},this.getById=function(e){return c.get(e)||null},this.getIndex=function(e){if(!s.validID(e))return-1;let t=f.get(e);return s.undef(t)?-1:t};const m=(e,t)=>{if(t.includes(".")){let n=t.split(".").filter((e=>!!e.trim())),i={...e};for(let e=0,t=n.length;e<t;e++)i=i[n[e]];return i}return e[t]};this.getByAttribute=function(e,t){if(!s.string(e)||s.undef(t))return null;for(let n of c.values()){if(m(n,e)===t)return n}return null},this.getFirstByAttribute=this.getByAttribute,this.getAllByAttribute=function(e,t){let n=[];if(!s.string(e)||s.undef(t))return n;for(let i of c.values()){t===m(i,e)&&n.push(i)}return n},this.setAttributes=function(e,n){if(!s.validID(e)||!s.object(n))return!1;if(s.string(e)&&!e.trim())return!1;let i=t.getById(e);return null!==i&&(!!o(i,n)&&(c.set(i.id,i),t.emit(`set-${a}`,i),!0))},this.setAttributesByAttribute=function(e,n,i){if(!s.string(e)||!s.object(i))return[];if(i.id&&delete i.id,Object.keys(i).length<1)return[];return this.getAllByAttribute(e,n).map((e=>o(e,i)?(c.set(e.id,e),t.emit(`set-${a}`,e),{[e.id]:!0}):{[e.id]:!1}))},this.insert=function(e,r){if(!s.validID(e)||!s.array(r))return!1;let o=t.getIndex(e);if(-1===o)return!1;let l=[];for(let e=0,n=r.length;e<n;e++)t.update(r[e])||l.push(r[e]);const m=Array.from(c.values());return l.forEach(((e,r)=>{e=new n(e),i&&-1===e.id&&(e.id=u());const s=o+1+r;m.splice(s,0,e),t.emit(`inserted-${a}`,e)})),t.clear(),m.forEach(((e,t)=>{c.set(e.id,e),f.set(e.id,t)})),!0},this.upsert=this.insert,this.update=function(e){if(!s.object(e)||!s.validID(e.id))return!1;if(-1===t.getIndex(e.id))return!1;let n=t.getById(e.id);return!!o(n,e)&&(c.set(e.id,n),t.emit(`updated-${a}`,n),!0)},this.remove=function(e){if(!s.validID(e))return!1;if(c.delete(e)){t.emit(`removed-${a}`,e);const n=f.get(e);return f.delete(e),f.forEach(((e,t)=>{e>=n&&f.set(t,e-1)})),!0}return!1}};
